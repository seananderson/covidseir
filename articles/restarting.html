<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fitting case data in multiple blocks • covidseir</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Fitting case data in multiple blocks">
<meta property="og:description" content="covidseir">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">covidseir</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1.9001</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/fitting-case-data.html">Fitting COVID-19 case data with covidseir</a>
    </li>
    <li>
      <a href="../articles/restarting.html">Fitting case data in multiple blocks</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="restarting_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Fitting case data in multiple blocks</h1>
            
      
      
      <div class="hidden name"><code>restarting.Rmd</code></div>

    </div>

    
    
<p>With longer time series, you may wish to split the model fitting into “blocks” for speed. This approach will let you fit a model once for the time series until a recent date (say a couple months ago), and then focus on fitting the more recent data separately, perhaps with full MCMC sampling given that the fitting will be considerably faster.</p>
<p>The following is an example of splitting the dataset in late May. You can split the data wherever and as frequently as you want providing the following is true:</p>
<ul>
<li>The blocks happen after the initial social distancing ramp</li>
<li>There is ~30 days before the split in which it is reasonable to assume that the contact rate fraction (f) is constant</li>
<li>You don’t end up with overly short f segments on either side of the split that can’t be reasonably estimated (say less than a week)</li>
</ul>
<p>You must also be OK with various otherwise fixed parameters (phi, R0, e, i0) being allowed to vary across blocks. The posterior from the fit will be used as the prior for the next. This means the information from the first block will be preserved, but the next block posterior may be different from the previous when additional data are added. Visually, the most obvious effect might be the NB2 dispersion parameter phi: the credible intervals may appear smaller or wider in different splits. One approach to deal with this is to allow for some overlap (say a week) between two fits and then average across them, as is done in the following example.</p>
<div id="data" class="section level1">
<h1 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h1>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">covidseir</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="va">ymd</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="va"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span></code></pre></div>
<p>First, we will read in the British Columbia, Canada COVID-19 reported-case data. This comes from <a href="http://www.bccdc.ca/Health-Info-Site/Documents/BCCDC_COVID19_Dashboard_Case_Details.csv" class="uri">http://www.bccdc.ca/Health-Info-Site/Documents/BCCDC_COVID19_Dashboard_Case_Details.csv</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">5</span>, <span class="fl">11</span>, <span class="fl">20</span>, <span class="fl">12</span>, 
<span class="fl">25</span>, <span class="fl">12</span>, <span class="fl">27</span>, <span class="fl">46</span>, <span class="fl">41</span>, <span class="fl">60</span>, <span class="fl">47</span>, <span class="fl">62</span>, <span class="fl">46</span>, <span class="fl">43</span>, <span class="fl">88</span>, <span class="fl">59</span>, <span class="fl">91</span>, <span class="fl">62</span>, <span class="fl">62</span>, <span class="fl">37</span>, 
<span class="fl">30</span>, <span class="fl">82</span>, <span class="fl">56</span>, <span class="fl">47</span>, <span class="fl">55</span>, <span class="fl">31</span>, <span class="fl">21</span>, <span class="fl">13</span>, <span class="fl">51</span>, <span class="fl">40</span>, <span class="fl">33</span>, <span class="fl">34</span>, <span class="fl">41</span>, <span class="fl">28</span>, <span class="fl">15</span>, <span class="fl">30</span>, 
<span class="fl">44</span>, <span class="fl">14</span>, <span class="fl">51</span>, <span class="fl">25</span>, <span class="fl">30</span>, <span class="fl">15</span>, <span class="fl">34</span>, <span class="fl">63</span>, <span class="fl">33</span>, <span class="fl">37</span>, <span class="fl">72</span>, <span class="fl">61</span>, <span class="fl">15</span>, <span class="fl">58</span>, <span class="fl">41</span>, <span class="fl">26</span>, 
<span class="fl">29</span>, <span class="fl">23</span>, <span class="fl">33</span>, <span class="fl">21</span>, <span class="fl">16</span>, <span class="fl">24</span>, <span class="fl">29</span>, <span class="fl">21</span>, <span class="fl">14</span>, <span class="fl">8</span>, <span class="fl">17</span>, <span class="fl">10</span>, <span class="fl">13</span>, <span class="fl">16</span>, <span class="fl">14</span>, <span class="fl">21</span>, 
<span class="fl">8</span>, <span class="fl">11</span>, <span class="fl">5</span>, <span class="fl">19</span>, <span class="fl">11</span>, <span class="fl">22</span>, <span class="fl">12</span>, <span class="fl">4</span>, <span class="fl">9</span>, <span class="fl">8</span>, <span class="fl">7</span>, <span class="fl">10</span>, <span class="fl">5</span>, <span class="fl">11</span>, <span class="fl">9</span>, <span class="fl">16</span>, <span class="fl">4</span>, <span class="fl">23</span>, 
<span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">12</span>, <span class="fl">7</span>, <span class="fl">9</span>, <span class="fl">10</span>, <span class="fl">14</span>, <span class="fl">12</span>, <span class="fl">17</span>, <span class="fl">14</span>, <span class="fl">14</span>, <span class="fl">9</span>, <span class="fl">11</span>, <span class="fl">19</span>, <span class="fl">9</span>, <span class="fl">5</span>, <span class="fl">9</span>, <span class="fl">6</span>, 
<span class="fl">17</span>, <span class="fl">11</span>, <span class="fl">12</span>, <span class="fl">21</span>, <span class="fl">12</span>, <span class="fl">9</span>, <span class="fl">13</span>, <span class="fl">3</span>, <span class="fl">12</span>, <span class="fl">17</span>, <span class="fl">10</span>, <span class="fl">9</span>, <span class="fl">12</span>, <span class="fl">16</span>, <span class="fl">7</span>, <span class="fl">10</span>, <span class="fl">19</span>, 
<span class="fl">18</span>, <span class="fl">22</span>, <span class="fl">25</span>, <span class="fl">23</span>, <span class="fl">20</span>, <span class="fl">13</span>, <span class="fl">19</span>, <span class="fl">24</span>, <span class="fl">33</span>, <span class="fl">44</span>, <span class="fl">19</span>, <span class="fl">29</span>, <span class="fl">33</span>, <span class="fl">34</span>, <span class="fl">32</span>, <span class="fl">30</span>, 
<span class="fl">30</span>, <span class="fl">21</span>, <span class="fl">21</span>, <span class="fl">24</span>, <span class="fl">47</span>, <span class="fl">26</span>, <span class="fl">39</span>, <span class="fl">52</span>, <span class="fl">29</span>, <span class="fl">48</span>, <span class="fl">28</span>, <span class="fl">43</span>, <span class="fl">46</span>, <span class="fl">47</span>, <span class="fl">51</span>, <span class="fl">38</span>, 
<span class="fl">42</span>, <span class="fl">46</span>, <span class="fl">86</span>, <span class="fl">73</span>, <span class="fl">90</span>, <span class="fl">100</span>, <span class="fl">86</span>, <span class="fl">51</span>, <span class="fl">77</span>, <span class="fl">65</span>, <span class="fl">84</span>, <span class="fl">90</span>, <span class="fl">115</span>, <span class="fl">79</span>, <span class="fl">81</span><span class="op">)</span>, 
    day <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">176</span><span class="op">)</span>, row.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="op">-</span><span class="fl">176L</span><span class="op">)</span>, 
  class <span class="op">=</span> <span class="st">"data.frame"</span><span class="op">)</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>
<span class="va">dat</span><span class="op">$</span><span class="va">date</span> <span class="op">&lt;-</span> <span class="fu">ymd</span><span class="op">(</span><span class="st">"2020-03-01"</span><span class="op">)</span> <span class="op">+</span> <span class="va">dat</span><span class="op">$</span><span class="va">day</span> <span class="op">-</span> <span class="fl">1</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="restarting_files/figure-html/plot-raw-dat-1.png" width="480"></p>
</div>
<div id="initial-model-setup" class="section level1">
<h1 class="hasAnchor">
<a href="#initial-model-setup" class="anchor"></a>Initial model setup</h1>
<p>See the ‘fitting-case-data’ vignette for details on the model setup. Here, we will use the same initial code blocks.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Based on estimation with hospital data in other model:</span>
<span class="va">samp_frac</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.14</span>, <span class="fl">13</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.21</span>, <span class="fl">38</span><span class="op">)</span><span class="op">)</span>
<span class="va">samp_frac</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">samp_frac</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.37</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">samp_frac</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">f_seg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">day_new_f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">date</span> <span class="op">==</span> <span class="fu">ymd</span><span class="op">(</span><span class="st">"2020-05-01"</span><span class="op">)</span><span class="op">)</span>
<span class="va">f_seg</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">day_new_f</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">f_seg</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">2</span>
<span class="va">day_ch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">date</span> <span class="op">==</span> <span class="fu">ymd</span><span class="op">(</span><span class="st">"2020-06-01"</span><span class="op">)</span><span class="op">)</span>
<span class="va">f_seg</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">day_ch</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">f_seg</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">3</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">first_day</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">date</span><span class="op">)</span>
<span class="va">lut</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
  day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fl">300</span><span class="op">)</span>,
  date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">first_day</span>, <span class="va">first_day</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">day</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, by <span class="op">=</span> <span class="st">"1 day"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="splitting-the-data-and-model-fit" class="section level1">
<h1 class="hasAnchor">
<a href="#splitting-the-data-and-model-fit" class="anchor"></a>Splitting the data and model fit</h1>
<p>First, let’s split the data into two blocks with a week overlap in the middle. Note that f is assumed constant in the 30 days prior. You could also avoid the overlap if you would prefer.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">date</span> <span class="op">&lt;</span> <span class="fu">ymd</span><span class="op">(</span><span class="st">"2020-05-29"</span><span class="op">)</span><span class="op">)</span>
<span class="va">dat2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">date</span> <span class="op">&gt;=</span> <span class="fu">ymd</span><span class="op">(</span><span class="st">"2020-05-22"</span><span class="op">)</span><span class="op">)</span>

<span class="va">samp_frac1</span> <span class="op">&lt;-</span> <span class="va">samp_frac</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dat1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
<span class="va">samp_frac2</span> <span class="op">&lt;-</span> <span class="va">samp_frac</span><span class="op">[</span><span class="va">dat2</span><span class="op">$</span><span class="va">day</span><span class="op">]</span>

<span class="va">f_seg1</span> <span class="op">&lt;-</span> <span class="va">f_seg</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dat1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
<span class="va">f_seg2</span> <span class="op">&lt;-</span> <span class="va">f_seg</span><span class="op">[</span><span class="va">dat2</span><span class="op">$</span><span class="va">day</span><span class="op">]</span></code></pre></div>
<p>Now we need to adjust the <code>f_seg</code> indexes to start at 1 in the second block and set the first element to 0:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">f_seg2</span> <span class="op">&lt;-</span> <span class="va">f_seg2</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">f_seg2</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>
<span class="va">f_seg2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="va">f_seg2</span>
<span class="co">#&gt;  [1] 0 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2</span>
<span class="co">#&gt; [39] 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2</span>
<span class="co">#&gt; [77] 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2</span></code></pre></div>
<p>Fit the first model:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_seir.html">fit_seir</a></span><span class="op">(</span>
  daily_cases <span class="op">=</span> <span class="va">dat1</span><span class="op">$</span><span class="va">value</span>,
  samp_frac_fixed <span class="op">=</span> <span class="va">samp_frac1</span>, 
  f_seg <span class="op">=</span> <span class="va">f_seg1</span>,
  i0_prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,
  e_prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">0.05</span><span class="op">)</span>,
  start_decline_prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span>, <span class="fl">0.1</span><span class="op">)</span>,
  end_decline_prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">22</span><span class="op">)</span>, <span class="fl">0.1</span><span class="op">)</span>,
  f_prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span>,
  R0_prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">2.6</span><span class="op">)</span>, <span class="fl">0.2</span><span class="op">)</span>,
  N_pop <span class="op">=</span> <span class="fl">5.1e6</span>, <span class="co"># BC population</span>
  iter <span class="op">=</span> <span class="fl">200</span>,
  fit_type <span class="op">=</span> <span class="st">"optimizing"</span> <span class="co"># for speed only</span>
<span class="op">)</span>
<span class="co">#&gt; Finding the MAP estimate.</span></code></pre></div>
<p>Use the function <code><a href="../reference/post2prior.html">covidseir::post2prior()</a></code> to convert the posteriors to the priors. The output is a named list:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/post2prior.html">post2prior</a></span><span class="op">(</span><span class="va">fit1</span>, iter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span><span class="op">)</span>
<span class="va">priors</span>
<span class="co">#&gt; $R0</span>
<span class="co">#&gt; [1] 1.15693778 0.07827417</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $i0</span>
<span class="co">#&gt; [1] 6.448225 0.178044</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $e</span>
<span class="co">#&gt; [1] 0.80952971 0.04981957</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $phi</span>
<span class="co">#&gt; [1] 2.0228785 0.2099876</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $f</span>
<span class="co">#&gt; [1] 0.3325996 0.0790145</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $start_decline</span>
<span class="co">#&gt; [1] 0.0 0.1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $end_decline</span>
<span class="co">#&gt; [1] 0.0 0.1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $state_0</span>
<span class="co">#&gt;      E1_frac      E2_frac       I_frac        Q_num        R_num     E1d_frac </span>
<span class="co">#&gt;    0.7736256    0.1539390    0.6359192   21.6524384 2020.5355935    0.3779521 </span>
<span class="co">#&gt;     E2d_frac      Id_frac       Qd_num       Rd_num </span>
<span class="co">#&gt;    0.0805407    0.4089279   69.7881628 7994.2094979</span></code></pre></div>
<p>Now we will fit the second model. <strong>Critically, note that we need to set <code>use_ramp = FALSE</code> to avoid using the initial social distancing ramp.</strong> The <code>start_decline_prior</code> and <code>end_decline_prior</code> are given fake priors that are close to 1 and easy to sample from. They can be ignored in the output.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_seir.html">fit_seir</a></span><span class="op">(</span>
  daily_cases <span class="op">=</span> <span class="va">dat2</span><span class="op">$</span><span class="va">value</span>,
  samp_frac_fixed <span class="op">=</span> <span class="va">samp_frac2</span>, 
  f_seg <span class="op">=</span> <span class="va">f_seg2</span>,
  i0_prior <span class="op">=</span> <span class="va">priors</span><span class="op">$</span><span class="va">i0</span>,
  e_prior <span class="op">=</span> <span class="va">priors</span><span class="op">$</span><span class="va">e</span>,
  start_decline_prior <span class="op">=</span> <span class="va">priors</span><span class="op">$</span><span class="va">start_decline</span>,
  end_decline_prior <span class="op">=</span> <span class="va">priors</span><span class="op">$</span><span class="va">end_decline</span>,
  state_0 <span class="op">=</span> <span class="va">priors</span><span class="op">$</span><span class="va">state_0</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>D <span class="op">=</span> <span class="fl">5</span>, k1 <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">5</span>, k2 <span class="op">=</span> <span class="fl">1</span>, q <span class="op">=</span> <span class="fl">0.05</span>, ud <span class="op">=</span> <span class="fl">0.1</span>, ur <span class="op">=</span> <span class="fl">0.02</span>, f0 <span class="op">=</span> <span class="va">priors</span><span class="op">$</span><span class="va">f</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,
  f_prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fl">0.6</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span>, <span class="co"># or use priors$f to use the last f segment posterior</span>
  R0_prior <span class="op">=</span> <span class="va">priors</span><span class="op">$</span><span class="va">R0</span>,
  use_ramp <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># CRITICAL for restarting!</span>
  N_pop <span class="op">=</span> <span class="fl">5.1e6</span>, <span class="co"># BC population</span>
  iter <span class="op">=</span> <span class="fl">200</span>,
  fit_type <span class="op">=</span> <span class="st">"optimizing"</span>, <span class="co"># for speed only</span>
  phi_prior <span class="op">=</span> <span class="va">priors</span><span class="op">$</span><span class="va">phi</span>
<span class="op">)</span>
<span class="co">#&gt; Finding the MAP estimate.</span></code></pre></div>
<p>Since we need to average over the overlap, we will combine the posteriors before turning them into a data frame with quantiles:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">proj1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/project_seir.html">project_seir</a></span><span class="op">(</span><span class="va">fit1</span>, iter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span><span class="op">)</span>
<span class="va">proj2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/project_seir.html">project_seir</a></span><span class="op">(</span><span class="va">fit2</span>, iter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span><span class="op">)</span>
<span class="va">proj2</span><span class="op">$</span><span class="va">day</span> <span class="op">&lt;-</span> <span class="va">proj2</span><span class="op">$</span><span class="va">day</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">dat2</span><span class="op">$</span><span class="va">day</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></code></pre></div>
<p>These are the fits from the two models:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">proj1</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/tidy_seir.html">tidy_seir</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/plot_projection.html">plot_projection</a></span><span class="op">(</span><span class="va">dat1</span><span class="op">)</span></code></pre></div>
<p><img src="restarting_files/figure-html/unnamed-chunk-2-1.png" width="480"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">proj2</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/tidy_seir.html">tidy_seir</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/plot_projection.html">plot_projection</a></span><span class="op">(</span><span class="va">dat2</span><span class="op">)</span></code></pre></div>
<p><img src="restarting_files/figure-html/unnamed-chunk-2-2.png" width="480"></p>
<p>Now we can bind the two projections together, convert them into quantiles, join on our day-date lookup table (<code>lut</code>), and plot the result. The vertical dashed lines indicate the region of overlapping/split model fits.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tidy_proj_combined</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">proj1</span>, <span class="va">proj2</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/tidy_seir.html">tidy_seir</a></span><span class="op">(</span>resample_y_rep <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">lut</span>, by <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span>

<span class="va">tidy_proj_combined</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plot_projection.html">plot_projection</a></span><span class="op">(</span>obs_dat <span class="op">=</span> <span class="va">dat</span>,
  value_column <span class="op">=</span> <span class="st">"value"</span>, date_column <span class="op">=</span> <span class="st">"date"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu">ymd</span><span class="op">(</span><span class="st">"2020-05-22"</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu">ymd</span><span class="op">(</span><span class="st">"2020-05-29"</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_light</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">150</span><span class="op">)</span>, expand <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; Coordinate system already present. Adding new coordinate system, which will replace the existing one.</span></code></pre></div>
<p><img src="restarting_files/figure-html/restart-plot2-1.png" width="480"></p>
<p>In this example you will notice that phi is estimated as larger (less dispersion) in the second block compared to the first, resulting in slightly smaller credible intervals than we would have had with a single fit:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">fit1</span><span class="op">$</span><span class="va">post</span><span class="op">$</span><span class="va">phi</span><span class="op">)</span>
<span class="co">#&gt; [1] 7.72943</span>
<span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">fit2</span><span class="op">$</span><span class="va">post</span><span class="op">$</span><span class="va">phi</span><span class="op">)</span>
<span class="co">#&gt; [1] 9.605443</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Sean C. Anderson, Andrew M. Edwards, Madi Yerlanov, Nicola Mulberry, Jessica E. Stockdale, Rebeca C. Falcao, Sarafa A. Iyaniwura, Michael C. Otterstatter, Michael A. Irvine, Naveed Z. Janjua, Daniel Coombs, Caroline Colijn.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
